services:
  # 后端 API 服务
  - type: web
    name: z-image-api
    env: python
    repo: https://github.com/xianyu110/z-image.git
    rootDir: .
    plan: free
    buildCommand: |
      pip install -r requirements.txt
    startCommand: |
      python zimage_proxy_simple.py
    envVars:
      - key: PORT
        value: 8000
      - key: PYTHONUNBUFFERED
        value: "true"
      - key: ZIMAGE_API_HOST
        value: https://zimage.run
      - key: ENABLE_KEEP_ALIVE
        value: "true"
    healthCheckPath: /health
    autoDeploy: true

  # 前端静态文件服务
  - type: web
    name: z-image-frontend
    env: static
    repo: https://github.com/xianyu110/z-image.git
    rootDir: web
    buildCommand: ""
    staticPublishPath: .
    plan: free
    routes:
      - type: rewrite
        source: /api/*
        destination: https://z-image-api.onrender.com
    autoDeploy: true

  # Keep-alive Cron 服务
  - type: cron
    name: z-image-keepalive
    repo: https://github.com/xianyu110/z-image.git
    schedule: "*/10 * * * *"  # 每10分钟运行一次
    buildCommand: |
      pip install requests
    startCommand: |
      python -c "
import requests
import os
from datetime import datetime

services = [
    os.environ.get('RENDER_URL', 'https://z-image-api.onrender.com')
]

print(f'[{datetime.now()}] Starting keep-alive pings...')

for service in services:
    try:
        response = requests.get(f'{service}/health', timeout=30)
        if response.status_code == 200:
            print(f'✅ {service} - OK')
        else:
            print(f'⚠️ {service} - Status: {response.status_code}')
    except Exception as e:
        print(f'❌ {service} - Error: {str(e)}')
"